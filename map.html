<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Bars Paris</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <!-- Barre de recherche compacte -->
    <div class="absolute top-4 left-4 z-[1000] max-w-xs w-full shadow-lg">
      <div class="flex gap-1 bg-white/90 backdrop-blur-sm rounded-lg p-1.5">
        <input
          type="text"
          id="searchInput"
          placeholder="Recherche adresse..."
          class="flex-grow text-sm px-2 py-1 border-none rounded-md focus:ring-0 bg-transparent"
        />
        <button
          id="searchButton"
          class="text-sm bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 transition-colors"
        >
          →
        </button>
      </div>
    </div>

    <div id="map"></div>

    <script>
      const map = L.map("map").setView([48.8566, 2.3522], 13);
      let searchMarker = null;

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      // Chargement des bars
      fetch("https://boire-facile-api.onrender.com/all_bars")
        .then((res) => res.json())
        .then((data) => {
          data.bars.forEach((bar) => {
            if (bar.latitude && bar.longitude) {
              L.marker([bar.latitude, bar.longitude])
                .addTo(map)
                .bindPopup(
                  `<div class="text-sm">
                    <strong class="font-semibold">${bar.nom}</strong><br>
                    <span class="text-gray-600">${bar.adresse}</span><br>
                    <span class="text-green-700">💶 ${bar.prix}</span><br>
                    <span class="text-blue-600">🕒 ${bar.happy_hour || "Pas d'HH"}</span>
                   </div>`
                );
            }
          });
        })
        .catch(console.error);

      // Gestion de la recherche
      const performSearch = () => {
        const query = document.getElementById("searchInput").value;
        if (!query) return;

        fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            query + " Paris"
          )}&limit=1&viewbox=2.2241,48.8156,2.4699,48.9022&bounded=1`
        )
          .then((res) => res.json())
          .then((data) => {
            if (data.length > 0) {
              const result = data[0];
              map.setView([result.lat, result.lon], 16);
              
              if (searchMarker) searchMarker.remove();
              
              searchMarker = L.marker([result.lat, result.lon], {
                icon: L.icon({
                  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41]
                })
              })
                .addTo(map)
                .bindPopup(`<div class="text-sm">📍 ${result.display_name}</div>`)
                .openPopup();
            }
          });
      };

      document.getElementById("searchButton").addEventListener("click", performSearch);
      document.getElementById("searchInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") performSearch();
      });
    </script>
  </body>
</html>
